######
# top-level Makefile for UberSpark
# author: amit vasudevan (amitvasudevan@acm.org)
######


include ./uberspark-common.mk


###### paths

export USPARK_DIR := $(realpath $(dir $(lastword $(MAKEFILE_LIST))))
export USPARK_DOCSDIR := $(USPARK_DIR)/docs
export USPARK_HWMDIR := $(USPARK_DIR)/src/hwm
export USPARK_INCLUDEDIR := $(USPARK_DIR)/src/include
export USPARK_TOOLSDIR := $(USPARK_DIR)/src/tools
export USPARK_BUILDSHIMSDIR := $(USPARK_DIR)/buildshims
export USPARK_LOADERSDIR := $(USPARK_DIR)/src/loaders
export USPARK_SENTINELSDIR := $(USPARK_DIR)/src/sentinels



###### targets

.PHONY: all
all: build-tools 

.PHONY: build-loaders
build-loaders:
	cd $(USPARK_LOADERSDIR) && $(MAKE) -w build

.PHONY: install-buildshims
install-buildshims:
	$(MKDIR) -p $(USPARK_INSTALL_BUILDSHIMSDIR)
	cp -R -f $(USPARK_BUILDSHIMSDIR)/*  $(USPARK_INSTALL_BUILDSHIMSDIR)/.

.PHONY: install-loaders
install-loaders:
	cd $(USPARK_LOADERSDIR) && $(MAKE) -w install

.PHONY: install-sentinels
install-sentinels:
	$(MKDIR) -p $(USPARK_INSTALL_SENTINELSDIR)
	cp -f $(USPARK_SENTINELSDIR)/*  $(USPARK_INSTALL_SENTINELSDIR)/.

.PHONY: install-uobjcoll
install-uobjcoll:
	$(MKDIR) -p $(USPARK_INSTALL_UOBJCOLLDIR)

.PHONY: build-tools
build-tools:
	cd $(USPARK_TOOLSDIR) && $(MAKE) -w all
	

.PHONY: install-tools
install-tools:
	#$(MKDIR) -p $(USPARK_INSTALL_TOOLSDIR)
	$(MKDIR) -p $(USPARK_INSTALL_BINDIR)
	$(CP) -f $(USPARK_TOOLSDIR)/driver/uberspark $(USPARK_INSTALL_BINDIR)/.


.PHONY: install-hdrs
install-hdrs:
	$(MKDIR) -p $(USPARK_INSTALL_INCLUDEDIR)
	$(CP) -f $(USPARK_INCLUDEDIR)/* $(USPARK_INSTALL_INCLUDEDIR)/.
	#$(CP) -f $(USPARK_DIR)/uberspark-common.mk $(USPARK_INSTALL_HOMEDIR)/.

#.PHONY: install-hwm
#install-hwm:
#	$(MKDIR) -p $(USPARK_INSTALL_HWMDIR)
#	$(CP) -rf $(USPARK_HWMDIR)/* $(USPARK_INSTALL_HWMDIR)/.

.PHONY: install
#install: install-tools install-buildshims install-uobjcoll install-hdrs install-hwm
#install: install-tools install-buildshims install-uobjcoll install-hdrs
install: install-tools 

.PHONY: docs_pdf
docs_pdf:
	rm -rf "$(USPARK_DOCSDIR)"/_build
	mkdir -p "$(USPARK_DOCSDIR)"/_build
	sphinx-build -b latex "$(USPARK_DOCSDIR)" "$(USPARK_DOCSDIR)"/_build
	@cd "$(USPARK_DOCSDIR)"/_build && make 

.PHONY: docs_html
docs_html:
	rm -rf "$(USPARK_DOCSDIR)"/_build
	mkdir -p "$(USPARK_DOCSDIR)"/_build
	sphinx-build -b html "$(USPARK_DOCSDIR)" "$(USPARK_DOCSDIR)"/_build

.PHONY: clean
clean:
	rm -rf $(UBERSPARK_DOC_PATH)_build




.PHONY: clean
clean:
	cd $(USPARK_TOOLSDIR) && $(MAKE) -w clean
	

# http://www.gnu.org/software/automake/manual/automake.html#Clean
.PHONY: distclean
distclean: clean
	$(RM) config.log config.status
	$(RM) uberspark-common.mk

###### autoconf rules

Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

configure: configure.ac
	./bsconfigure

